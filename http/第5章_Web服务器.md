# 第5章 Web服务器

目录
[TOC]

## 读书笔记
- Web服务器实现了HTTP和相关的TCP连接处理，负责管理Web服务器提供的资源，以及对Web服务器的配置、控制及扩展方面的管理
- 基本Web服务器请求的步骤：
    1. 建立连接 - 接受一个客户端连接，或如果不希望与这个客户端建立连接就将其关闭
    2. 接受请求 - 从网络中读取一条HTTP请求报文
    3. 处理请求 - 对请求报文进行解释，并采取行动
    4. 访问资源 - 访问报文中指定的资源
    5. 构建响应 - 创建带有正确首部的HTTP响应报文
    6. 发送响应 - 将响应回送给客户端
    7. 记录事务处理过程 - 将与已完成事务有关的内容记录在一个日志文件中

## 5.1 各种形状和尺寸的Web服务器
Web服务器会对HTTP请求进行处理并提供响应，可以表示Web服务器的软件，也可以表示提供Web页面特定设备或计算机

所有的Web服务器都能够接收请求资源的HTTP请求，将内容回送给客户端

### 5.1.1 Web服务器的实现
Web服务器实现了HTTP和相关的TCP连接处理，负责管理Web服务器提供的资源，以及对Web服务器的配置、控制及扩展方面的管理

Web服务器逻辑实现了HTTP协议、管理着Web资源、并负责提供Web服务器的管理功能

Web服务器逻辑和操作系统共同负责管理TCP连接

底层操作系统负责管理计算机系统的硬件细节，提供了TCP/IP网络支持、负责装载Web资源的文件系统以及控制当前计算活动的进程管理功能

不同形式的Web服务器：
- 标准计算机系统上安装并运行通用的软件Web服务器
- Web服务器设备，安装在机架上，软件预装并配置好
- 计算机芯片上实现嵌入式Web服务器

### 5.1.2 通用软件Web服务器
通用软件Web服务器都运行在标准的、有网络功能的计算机系统上，可选择开源软件(Apache或W3C的Jigsaw)或者商业软件(iPlanet的Web服务器)

### 5.1.3 Web服务器设备
Web服务器设备(Web server appliance)是预先打包好的软硬件解决方案，不再需要安装及配置软件，通常可以极大地简化管理工作

缺点：不太灵活、特性不太丰富、而且服务硬件也不容易重用或升级

### 5.1.4 嵌入式Web服务器
嵌入式服务器是要嵌入到消费类产品中去的小型Web服务器，嵌入式Web服务器允许用户通过便捷的Web浏览器接口来管理其消费者设备

## 5.2 最小的Perl Web服务器 - 略
Web服务器软件就是要支持HTTP/1.1的各种特性：丰富的资源支持、虚拟主机、访问控制、日志记录、配置、监视和性能特性

## 5.3 实际的Web服务器会做什么
基本Web服务器请求的步骤：
1. 建立连接 - 接受一个客户端连接，或如果不希望与这个客户端建立连接就将其关闭
2. 接受请求 - 从网络中读取一条HTTP请求报文
3. 处理请求 - 对请求报文进行解释，并采取行动
4. 访问资源 - 访问报文中指定的资源
5. 构建响应 - 创建带有正确首部的HTTP响应报文
6. 发送响应 - 将响应回送给客户端
7. 记录事务处理过程 - 将与已完成事务有关的内容记录在一个日志文件中

## 5.4 第一步 接受客户端连接
### 5.4.1 处理新连接
客户端请求一条到Web服务器的TCP连接时，Web服务器会建立连接，判断连接的另一端是哪个客户端，从TCP连接中将IP地址解析出来

一旦新连接建立起来并被接受，服务器就会将新连接添加到其现存Web服务器连接列表中，做好监视连接上数据传输的准备

Web服务器可以随意拒绝或立即关闭任意一条连接(未认证、已知的恶意客户端等)

### 5.4.2 客户端主机名识别
可以用反向DNS对大部分Web服务器进行配置，将客户端IP地址转成客户端主机名

Web服务器将客户端主机名用于详细的访问控制和日志记录

主机名查找耗时，会降低Web事务处理速度，很多大容量Web服务器要么禁止主机名解析，要么只允许对特定内容进行解析

### 5.4.3 通过ident确定客户端用户
服务器能通过ident协议找到发起HTTP连接的用户名，客户端若支持ident协议，就在TCP端口113上监听ident请求

ident在公共因特网上并不能很好地工作：
1. 很多客户端没有允许ident识别协议守护进程软件
2. ident协议会使HTTP事务处理产生严重的时延
3. 很多防火墙不允许流量进入
4. ident协议不安全，容易被伪造
5. ident协议也不支持虚拟IP地址
6. 暴露客户端的用户名还涉及隐私问题

没有ident信息可用，Apache会用连字符(-)来填充ident日志字段

## 5.5 第二步 接收请求报文
连接上有数据到达时，Web服务器会从网络连接中读取数据，并将请求报文中的内容解析出来

解析请求报文时，Web服务器会：
- 解析请求行，查找请求方法、指定的资源标识符以及版本号
- 读取以CRLF结尾的报文首部
- 检测到以CRLF结尾的、标识首部结束的空行
- 如果有主体(长度由Content-Length首部决定)，则读取请求主体

解析请求报文时，Web服务器会不定期地从网络上接收输入数据(网络连接可能出现延时)，会将部分报文数据临时存储在内存中，直到收到足以进行解析的数据并理解其意义为止

### 5.5.1 报文的内部表示法
有些Web服务器还会用便于进行报文操作的内部数据结构来存储请求报文，把数据结构中的指针及其长度存放在一个快速查询表中，以便快速访问特定首部的具体指

### 5.5.2 连接的输入/输出处理结构
高性能的Web服务器能够同时支持数千条连接，请求会在任意时刻到达，则Web服务器会不停地观察有无新的Web请求

不同的Web服务器结构会以不同的方式为请求服务：
- 单线程Web服务器：一次只处理一个请求，直到处理完为止
    * 易于实现
    * 处理过程会忽略其他连接，造成严重的性能问题
    * 只适合低负荷的服务器，以及像type-o-server的诊断工具
- 多进程及多线程Web服务器：用多个进程，或更高效的线程同时对请求进行处理
    * 每条连接若分配一个进程/线程，需要的线程/进程数量可能会消耗太多的内存或系统资源
    * 需要对很多线程Web服务器进行对线程/进程的最大数量进行限制
- 复用I/O的服务器 - 监视所有连接上的活动，当连接状态发生变化，就对其进行少量处理，处理结束则将连接返回到开放连接列表
    * 支持大量的连接
    * 只有在连接状态有变化的时候，才去绑定线程/进程
- 复用的多线程Web服务器 - 多线程和复用功能结合，多个线程中每个都在观察打开的连接，并对每条连接执行少量的任务

## 5.6 第三步 处理请求
Web服务器收到请求，会根据方法、资源、首部和可选主体部分来对请求进行处理

## 5.7 第四步 对资源的映射及访问
Web服务器是资源服务器，负责发送预先创建好的内容
*e.g.* HTML页面或JEPG图片，以及运行在服务器上的资源生成程序所产生的动态内容

将请求报文中的URI映射为Web服务器上适当的内容或内容生成器，以识别出内容的源头，传送给客户端

### 5.7.1 docroot(document root)
Web服务器支持各种不同类型的资源映射，最简单的就是用请求URI作为名字来访问Web服务器文件系统的文件

**文档的根目录(docroot)** - Web服务器的文件系统中会有一个特殊的文件夹专门用于存放Web内容

Web服务器从请求报文中获取URI，并将其附加在文档根目录的后面

#### 1.虚拟托管的docroot
虚拟托管的Web服务器会在同一台Web服务器上提供多个Web服务器提供多个Web站点，每个站点在服务器上都有自己独有的文档根目录

虚拟托管Web服务器会根据URI或Host首部的IP地址或主机名来识别要使用的正确文档根目录

即使请求URI完全相同，托管在同一个Web服务器上的两个Web站点也可以拥有完全不同的内容

#### 2.用户的主目录docroot
私有docroot会把那些以斜杠和波浪号(/~)开始，后面跟着用户名的URI映射，通常为用户主目录下那个名为public_html的目录

### 5.7.2 目录列表
Web服务器可以接收对目录URL的请求，其路径可以解析为一个目录，而不是文件

通过对Web服务器进行配置，使其**在客户端请求目录URL**时采取不同的动作：
- 返回一个错误
- 不返回目录，返回一个特殊的默认“索引文件”
- 扫描目录，返回一个包含目录内容的HTML页面

### 5.7.3 动态内容资源的映射
Web服务器可以将URI映射为动态资源，映射到按需动态生成的内容的程序(网关)上去

Web服务器要能够分辨出资源什么时候是动态的，动态内容生成程序位于何处以及如何运行那个程序

### 5.7.4 服务器端包含项
某个资源被标识为存在服务器包含项，服务器就会在将其发送客户端之前对资源内容进行处理

创建动态内容：对内容进行扫描，以查找(通常包含在特定HTML注释中的)特定的模板，这些模板可以是变量名，也可以是嵌入式脚本，也可用变量的值或可执行脚本的输出来取代特定的模板

### 5.7.5 访问控制
Web服务器还可以为特定资源进行访问控制，有请求到达，要访问受控资源时，Web服务器可以根据客户端的IP地址进行访问控制，也可以要求输入密码来访问资源

## 5.8 构建响应
Web服务器识别出了资源，就执行请求方法中描述的动作，并返回响应报文；响应报文中包含响应状态码、响应首部和响应主体(如果有响应主体的话)

### 5.8.1 响应实体
响应报文中通常包括：
- 描述了响应主体的MIME类型的Content-Type首部
- 描述了响应主体长度的Content-Length首部
- 实际报文的主体内容

### 5.8.2 MIME类型
Web服务器要负责确定响应主体的MIME类型，通过Web服务器配置将MIME类型和资源关联起来

- MIME类型(mime.types)：**文件的扩展名**来说明MIME类型
- 魔法分类(Magic typing): Apache Web服务器扫描每个**资源的内容**，并将其与一个已知模式表(魔法文件)进行匹配来决定文件的MIME类型
- 显式分类(Explicit typing): Web服务进行配置，使其**不考虑文件的扩展名或内容**，强制特定文件或目录内容拥有某个MIME类型
- 类型协商：Web服务器配置过后可以以多种文档格式来存储资源，会通过与用户协商来决定使用哪种格式最好

### 5.8.3 重定向
**重定向** - Web服务器可以将浏览器重定向到其他地方执行请求，重定向响应由返回3XX说明

Location响应首部包含了内容的新地址或优选地址

重定向的适用情况：
- 永久删除的资源：资源可能移动新的位置，或者被重新命名，有了新的URL(301 Moved Permanently)
- 临时删除的资源：资源被临时移走或重命名，重定向到新的位置上(303 See Other 307 Temporary)
- URL增强：重写URL，重新发起请求，往往用于嵌入上下文(303 See Other 307 Temporary)
- 负载均衡：一个超载的服务器收到一条请求，服务器可以将客户端重定向到一个负载不太重的服务器上(303 See Other 307 Temporary)
- 服务器关联：Web服务器上可能会有某些用户的本地信息，服务器可以将客户端重定向到包含了那个客户端信息的服务器上去(303 See Other 307 Temporary)
- 规范目录名称：客户端请求URI是一个不带尾部斜线的目录名时，大多数Web服务器都会将客户端重定向到一个加了斜线的URI上

## 5.9 第六步 发送响应
Web服务器通过连接发送数据时也会面临与接收数据一样的问题：服务器可能有很多条到各个客户端的连接，有些空闲，有些在向服务器发送数据，还有一些在向客户端回送响应数据

因此，服务器要记录连接的状态：
- 对非持久连接而言，发送了整条报文之后关闭自己一端的连接
- 对于持久连接而言，连接可能仍要保持打开状态，要正确计算Conent-Length首部

## 5.10 第七步 记录日志
当事务结束时，Web服务器会在日志文件中添加一个条目，来描述已执行的事务

## 5.11 更多信息 - 略