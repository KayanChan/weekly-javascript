# 第6章 代理

目录
[TOC]

## 6.1 Web的中间实体
Web代理(proxy)服务器是网络的中间实体，位于客户端和服务器之间，在各端点之间来回转送HTTP报文

### 6.1.1 私有和共享代理
代理服务器可以是某个客户端专用的，也可以是很多客户端共享的

对Web客户端来说，代理扮演的是服务器的角色，接收请求报文，返回响应报文
对Web服务器来说，代理扮演的是客户端的角色，发送Web请求报文，接收Web响应报文

**私有代理** - 单个客户端专用的代理
- 不常见，但确实存在，直接运行在客户端计算机上(*e.g.* 浏览器辅助产品以及一些ISP服务)


**公共代理** - 众多客户端共享的代理
- 大多数代理都是公共的共享代理
- 集中式代理的费效比更高、更容易管理(*e.g.* 高速缓存代理服务器，会利用用户间共同的请求)

### 6.1.2 代理与网关的对比
代理：连接两个或多个使用**相同协议**的应用程序
*e.g.* 浏览器与Web服务器的中间设备是Web代理，它们之间使用的都是HTTP协议

网关：连接两个或多个使用**不同协议**的端点，网关扮演协议转换器的角色，客户端和服务器使用不同的协议，客户端也可以通过它完成与服务器之间的事务处理
*e.g.* 浏览器与E-mail服务器(不基于Web的POP E-mail)的中间设备是Web/E-mail网关，网关会将Web事务转换成适当的POP事务

实际上，当浏览器与服务器实现的是不同版本的HTTP，代理也需要做一些协议转换的工作；商业化的代理服务器也会实现网关的功能来支持SSL安全协议、SOCKS防火墙、FTP访问以及基于Web的应用程序

## 6.2 为什么使用代理
代理服务器可以改善安全性、提高性能、节省费用

代理服务器可以接触到所有流过的HTTP流量，所以代理可以监视流量并对其修改，实现增值Web服务

代理使用方法示例：
- 儿童过滤器
利用过滤器来阻止学生访问成人内容
- 文档访问控制
在Web服务器与Web资源之间实现统一的访问控制策略，创建审核跟踪机制(指定客户端可以访问，指定可访问的文件，要求通过口令访问等)
- 安全防火墙
在网络中的单一安全节点上限制哪些应用层协议的数据可以流入或流出一个组织，提供用来消除病毒的Web和E-mail代理使用的挂钩程序，对流量进行详细检查
- Web缓存
代理缓存维护了常用文档的本地副本，并将它们按需提供，减少缓慢且昂贵的因特网通信
- 反向代理
代理假扮Web服务器，代理(反向代理，reverse proxy)接收发给Web服务器的真实请求，可以发起与其他服务器的通信，以便按需定位所请求的内容；也可以用反向代理来提高访问慢速Web服务器上的公共内容时的性能(服务器加速器, server accelerator)；还可以将反向代理与内容路由功能配合，以创建按需复制内容的分布式网络
- 内容路由器
根据因特网流量状况以及内容类型将请求导向特定的Web服务器，也可实现各种服务级的请求(*e.g.* 为性能高要求的付费用户转发请求到附近的复制缓存；过滤服务可以通过过滤代理来转发HTTP请求)
- 转码器
代理服务器在将内容发送给客户端之前可以修改内容的主体格式
- 匿名者
匿名者代理会主动从HTTP报文中删除身份特性(*e.g.* 客户端IP、From首部、referer首部、cookie、URI的会话ID)，提供高度的私密性和匿名性，但是可能会导致站点无法正常工作
    * 删除From首部，保护用户的E-mail地址
    * 删除referer首部，掩盖用户访问过的其他站点
    * 删除Cookie首部，剔除概要信息和身份的数据()

## 6.3 代理会去往何处
### 6.3.1 代理服务器的部署
部署代理服务器的几种方式：
1. 出口代理
将代理固定在本地网络的出口点，控制本地网络与大型因特网之间的流量

*e.g.* 学校过滤出口代理来防止早熟的学生浏览不恰当的内容

2. 访问(入口)代理
代理常被放在ISP(互联网服务提供商)访问点上，处理来自客户的聚合请求；

*e.g.* ISP使用缓存代理来存储常用文档的副本，提高用户的下载速度，降低因特网带宽耗费

3. 反向代理
被部署在网络边缘，在Web服务器之前；可以处理所有传送给Web服务器的请求，并只在必要时向Web服务器请求资源

*e.g.* 反向代理通常直接冒用Web服务器的名字和IP地址，这样所有的请求会被发送给代理而不是服务器

4. 网络交换代理
将具有足够处理能力的代理放在网络之间的因特网对等交换点上，通过缓存来减轻因特网节点的拥塞，并对流量进行监视

### 6.3.2 代理的层次结构
**代理层次结构**(proxy hierarchy)将代理级联起来，将报文从一个代理传给另外一个代理，直到最终抵达原始服务器为止，然后代理传回客户端

Proxy层次结构中的代理服务器被赋予父子关系，靠近服务器的代理为父代理，靠近客户端的代理被称为子代理

代理层次结构可以是静态的，也可以是动态的，将报文转发给一个不断变化的代理服务器和原始服务器集

*e.g.* 动态选择父代理的例子：
- 负载均衡
子代理会根据当前父代理上的工作负载级别来决定如何选择一个父代理

- 地理位置附近的路由
子代理可能会选择负责原始服务器所在物理区域的父代理

- 协议/类型路由
根据URI将报文转发到不同的父代理和原始服务器上

- 基于订购的路由
如果发布者为高性能服务额外付费，其URI会被转发到大型缓存或压缩引擎上以提高性能

### 6.3.3 代理是如何获得流量
客户端流量流向代理的四种常见方式：
1. 修改客户端
很多Web客户端，都支持手工和自动的代理配置，配置使用代理服务器后，HTTP请求有意直接发送给代理，而不是原始服务器

2. 修改网络
网络基础设施可以通过若干技术手段，在客户端不知道或没参与的情况下，拦截网络流量并将其导入代理(被称为拦截代理)，通常依赖监视HTTP流量的交换设备和路由设备

3. 修改DNS的命名空间
手工编辑DNS名称列表，或者用特殊的动态DNS服务器根据需要来确定适当的代理或服务器，假扮Web服务器的名字和IP地址，接收了请求

4. 修改Web服务器
将某些Web服务器配置为向客户端发送一条HTTP重定向命令(响应码305)，请求重定向到一个代理上；客户端收到重定向命令后，客户端会与代理进行通信

### 6.4 客户端的代理设置
所有现代的Web浏览器都允许用户对代理的时延进行配置

浏览器配置代理的方式：
- 手工配置
显式地设置使用的代理

- 预先配置浏览器
浏览器厂商或发行商会在预先对浏览器(或者Web客户端)的代理设置进行手工配置

- 代理的自动配置
提供一个URI，指向一个用Javascript语言编写的代理自动配置文件，客户端会取回这个JS文件，并运行它以决定是否应该使用一个代理，使用哪个代理服务器

- WPAD的代理发现
有些浏览器支持Web代理自动发现协议，它会自动检测出浏览器可以从哪个配置服务器下载到一个自动配置文件

### 6.4.1 客户端的代理配置：手工配置
思想：为代理指定主机和端口，有些ISP会向客户发送预先配置好的浏览器，或定制好的操作系统，使其将Web流量重定向到代理服务器上

### 6.4.2 客户端代理配置：PAC文件
PAC文件是一些小型的JavaScript程序，可以在运行过程中计算代理设置；浏览器会从这个URI上获取PAC文件，并用JavaScript逻辑为每次访问计算恰当的代理服务器

### 客户端代理配置：WPAD
WPAD协议是一种浏览器配置机制，其算法会使用发现机制的逐级上升策略自动地位浏览器查找适合的PAC文件

## 6.5 与代理请求有关的一些问题
### 6.5.1 代理URI与服务器URI不同
Web服务器报文与Web代理报文的语法是一样的，但客户端向服务器发送的请求报文跟客户端向代理发送的请求报文的URI有所不同

客户端向Web服务器发送请求时，请求行中只包含部分URI(没有方案、主机或端口) *e.g.* GET /index.html HTTP/1.0

客户端想代理发送请求时，请求行中则包含完整的UTI *e.g.* GET http://www.marys-antique.com/index.html HTTP/1.0

代理需要知道目标服务器的名称，才能建立与服务器的连接

### 6.5.2 与虚拟主机一样的问题
虚拟主机Web服务器会在很多Web站点间共享同一个物理Web服务器，也是需要知道目的Web站点的主机名和端口

但虚拟主机Web的解决方法与代理的不同：
- 显式的代理要求在请求报文中使用完整URI来解决问题
- 虚拟主机Web服务器要求Host首部来承载主机和端口信息

### 6.5.3 拦截代理会收到部分URI
以下两种情况客户端会认为自身在与Web服务器进行对话，不会发送完整URI：
1. 反向代理，代理服务器取代原始服务器，假扮服务器的主机名或IP地址
2. 拦截代理，网络流量中的代理服务器，拦截从客户端发往服务器的请求，并提供一个缓存响应，或对其进行转发

### 6.5.4 代理既可以处理代理请求，也可以处理服务器请求
通用的代理既应该支持请求报文中的完整URI，也应该支持部分URI

显示的代理请求 - 完全URI
Web服务器请求 - 部分URI和虚拟Host首部

### 6.5.5 转发过程中对URI的修改
