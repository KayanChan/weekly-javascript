# 第3章 HTTP报文

目录
[TOC]

## 读书笔记
1. 报文的流动 - 流入、流出、上游、下游
2. 报文的组成：起始行、首部、主体
3. 报文的分类及其内容 - 请求报文 & 响应报文
4. HTTP常用方法 - GET、POST
5. HTTP常用状态码 - 200、304、401、404、500、503
6. 首部的语法以及各种首部的介绍

## 3.1 报文流

HTTP报文是在HTTP应用程序之间发生的数据块

报文在客户端、服务器和代理之间流动

“流入”，“流出”，“上游”，“下游”都是用来描述HTTP报文的流动方向的术语

### 3.1.1 报文流入源端服务器

**流入(inbound)** 和 **流出(outbound)**是用来描述事务处理的方向

*e.g.* 报文流入源端服务器(流向服务器)，报文流出服务器(流向客户端)

### 3.1.2 报文向下游流动
所有报文(请求/响应报文)都会向**下游(downstream)**流动

所有报文的发送者都在接收者的**上游(upstream)**

## 3.2 报文的组成部分
报文由三个组成部分：对报文进行描述的**起始行(start line)**、包含属性的 **首部(headers)** 块、以及可选的包含数据的 **主体(body)** 部分

### 3.2.1 报文的语法
HTTP报文分为：请求报文 和 响应报文

**请求报文(request message)**会向Web服务器请求一个动作

**响应报文(response message)**会将请求的结果返回客户端

请求报文格式：
```html
<method><request-URL><version>
<headers>
<entity-body>
```

响应报文格式：
```html
<version><status><reason-phrase>
<headers>
<entity-body>
```

报文格式简要描述：
* 方法 method - 客户端希望服务器对资源执行的动作
* 请求URL request-URL - 命名了所请求资源，或者URL路径组件的完整URL
* 版本 version - 报文中使用的HTTP版本
* 状态码 status-code - 三位数字描述了请求过程中所发生的事情
* 原因短语 reason-phrase - 数字状态码的可读版本，包含行终止序列之前的所有文本
* 首部 header - 可以有零个或多个首部；每个首部包含`名字:(可选空格)值`;首部由一个空行(CFLF)结束的，表示首部列表的结束和实体主体的开始
* 实体的主体部分 entity-body - 实体的主题部分包含一个由任意数据组成的数据块

### 3.2.2 起始行
HTTP报文都以起始行作为开始

**请求行** - 请求报文请求服务器对资源进行一些操作，请求报文的起始行，包含一个方法和一个请求URL

**响应行** - 响应报文承载了状态信息和操作产生的结果数据，将其返回客户端，响应报文的其实行，包含HTTP版本、数字状态码以及猫叔操作状态的文本形式的原因短语

**方法**请求的起始行的开始，用来告知服务器要做些什么

常用HTTP方法

| 方法    | 描述                                               | 是否包含主体 |
| ------- | -------------------------------------------------- | :----------: |
| GET     | 从服务器获取一份文档                               |      否      |
| HEAD    | 只能服务器获取文档的首部                           |      否      |
| POST    | 向服务器发送需要处理的数据                         |      是      |
| PUT     | 将请求的主体部分存储在服务器上                     |      是      |
| TRACE   | 对可能经过代理服务器传送到服务器上去的报文进行追踪 |      否      |
| OPTIONS | 决定可以在服务器上执行哪些方法                     |      否      |
| DELETE  | 从服务器上删除一份文档                             |      否      |

除以上常用的7种方法，其他服务器可能还会实现一些自己的请求方法，对HTTP规范的扩展，称为扩展方法

**状态码**位于响应的起始行中，包含一个数字状态和一个可读的状态；数字码便于程序进行差错处理，原因短语便于人们理解

状态码分类：
* 200 - 299：状态码表示成功
* 300 - 399：资源已经被移走
* 400 - 499: 客户端请求出错
* 500 - 599：服务器出错

**原因短语**为状态码提供文本形式的解析，状态码的可读版本

**版本号**以HTTP/x.y的形式出现在请求和响应报文的起始行中，目的为使用HTTP的应用程序时，了解对方的能力和报文格式

### 3.2.3 首部
HTTP首部字段向请求和响应报文中添加了一些附加信息(名/值对的列表)

首部语法：字段名+`:`+可选空格+字段值，最后是一个CRLF

**首部延续行** - 将长的首部行分为多行提高可读性，换行的部分前面至少有一个空格或者制表符(tab)
```js
Server: Test Server
    Version 1.0
```

### 3.2.4 实体的主体部分
**实体主体**是HTTP报文的负荷(传输的内容)，HTTP报文可选的部分

### 3.2.5 版本0.9的报文
HTTP/0.9作为第一个版本，没有版本信息，没有状态码跟原因短语，没有首部；请求中只包含方法和请求URL，响应中只包含实体(缺乏灵活性，存在局限性)

## 3.3 方法
不是每个服务器都实现了所有的方法，考虑兼容，只要为资源实现`GET`和`HEAD`方法即可

### 3.3.1 安全方法
HTTP定义了一组被称为安全方法的方法：GET方法和HEAD方法

GET方法和HEAD方法的请求不会产生什么动作(即不会在服务器产生什么结果)

### 3.3.2 GET
**GET**通常用于请求服务器发送某个资源

HTTP/1.1要求服务器实现此方法

### 3.3.3 HEAD
**HEAD**与GET的行为类似，但只返回首部，不返回实体部分

HEAD的使用场景：
1. 在不获取资源的情况下了解资源的情况，比如判断类型
2. 通过查看响应中的状态码，看对象是否存在
3. 通过查看首部，测试资源是否被修改

服务器开发者必须确保返回的首部与GET请求的首部完全相同，若遵循HTTP/1.1规范就必须实现HEAD方法

### 3.3.4 PUT
**PUT**会向服务器写入文档，就是让服务器用请求的主体部分来创建一个由请求URL命名的新文档，URL已存在则替代

PUT允许用户对内容进行修改，所以Web服务器往往都要求执行PUT之前密码登录

### 3.3.5 POST
**POST**起初用户向服务器输入数据的，实际会用来支持HTML的表单

### 3.3.6 TRACE
**TRACE**会在目的服务器端发起一个环回诊断，不能带实体的主体部分

请求可能穿过防火墙、代理、网关或其他一些应用程序，每个中间节点都可能会修改原始的HTTP请求，行程最后一站的服务器会弹回一条TRACE响应，并在响应主体中携带它收到的原始请求报文

### 3.3.7 OPTIONS
**OPTIONS**请求Web服务器告知其支持的各种功能

### 3.3.8 DETELE
**DELETE**请求服务器删除请求URL所指定的资源

HTTP规范允许服务器在不通知客户端的情况下撤销请求，所以无法保证删除操作一定会被执行

### 3.3.9 扩展方法
HTTP被设计成可扩展的，这样新特性就不会使老的软件失效

**扩展方法**指的就是没有在HTTP/1.1规范中定义的方法

扩展方法示例
* LOCK - 允许用户锁定资源，比如在编辑资源的同时锁定，以防别人同时对其修改
* MKCOL - 允许用户创建资源
* COPY - 便于在服务器上复制资源
* MOVE - 在服务器移动资源

在不破坏端到端行为的情况下将带有位置方法的报文传递给下游服务器，代理会尝试传递报文，否则会以501状态码进行响应

## 3.4 状态码
状态码为客户端提供了一只理解事务处理结果的便捷方式

### 3.4.1 100~199 - 信息性状态码

| 状态码 | 原因短语            | 含义                                                         |
| :----: | ------------------- | ------------------------------------------------------------ |
|  100   | Continue            | 说明收到请求的初始部分，请客户端继续。发生这个状态码后，服务器在收到请求之后必须进行响应 |
|  101   | Switching Protocols | 说明服务器正在根据客户端的指定，将协议切换成Update首部所列的协议 |

### 3.4.2 200~299 - 成功状态码

| 状态码  | 原因短语                      | 含义                                                         |
| :-----: | ----------------------------- | ------------------------------------------------------------ |
| **200** | OK                            | 请求没问题，实体主体部分包含了所请求的资源                   |
|   201   | Create                        | 用户创建服务器对象的请求(比如 PUT)                           |
|   202   | Accepted                      | 请求已接受，但服务器还未对其执行任何动作，不能保证服务器会完成这个请求 |
|   203   | Non-Authoritative Information | 实体首部包含的信息不是源自于源服务器，而是来自资源的一份副本 |
|   204   | No Content                    | 响应报文中包含若干首部和一个状态行，但没有实体主体(（用于浏览器不转为显示新文档的情况下，对其进行更新-刷新表单页面 ） |
|   205   | Reset Content                 | 用于浏览器，负责告知浏览器清楚当前页面的所有HTML表单元素     |
|   206   | Partial Content               | 成功执行了一个部分或范围请求（206响应必须包含Content-Range、Date以及ETag 或 Content-Location） |

### 3.4.3 300~399 - 重定向状态码

重定向状态码可以告知客户端使用替代位置访问目标资源，或可以提供一个替代的响应来进行访问

重定向状态码可对资源的应用程序本地副本与源端服务器的资源进行对比

*e.g.* HTTP应用程序可以查看其资源的本地副本是否仍然是最新的，或者在源端服务器是否已经被修改过


| 状态码  | 原因短语           | 含义                                                         |
| ------- | ------------------ | ------------------------------------------------------------ |
| 300     | Multipe Choices    | 客户端请求一个实际指向多个资源的URL（服务器可在Location首部包含首选URL） |
| 301     | Moved Permanently  | 在请求的URL已被移除时使用（响应Location首部应该包含资源现在所处的URL） |
| 302     | Found              | 与301状态码类似（客户端应该使用Location首部给出URL来临时定位资源，将来请求还是使用旧的URL） |
| 303     | See Other          | 告知客户端应该使用另外一个URL来获取资源                      |
| **304** | Not Modified       | GET请求资源，资源最近没有被修改（这个响应报文应该不包含实体主体） |
| 305     | Use Proxy          | 必须通过一个代理来访问资源（代理位置由Location提供）         |
| 306     | 未使用             |                                                              |
| 307     | Temporary Redirect | 与301状态码类似（客户端应该使用Location首部给出URL来临时定位资源，将来请求还是使用旧的URL） |

由于HTTP/1.0和HTTP/1.1应用程序对状态码的处理方式存在差异导致状态码存在一些交叉（301、302、307）

### 3.4.4 400~499 - 客户端错误状态码

| 状态码  | 原因短语                        | 含义                                                         |
| ------- | ------------------------------- | ------------------------------------------------------------ |
| 400     | Bad Request                     | 告知客户端它发送了一个错误请求                               |
| **401** | Unauthorized                    | 在请求获取对资源的访问权之前，对自己进行认证                 |
| 402     | Payment Required                | 被保留，作未来之用                                           |
| **403** | Forbidden                       | 请求被服务器拒绝                                             |
| **404** | Not Found                       | 服务器无法找到所请求的URL                                    |
| 405     | Method Not Allowed              | 发起的请求中带有所请求的URL不支持的方法时，使用此状态码      |
| 406     | Not Acceptable                  | 客户端可以指定参数说明他们愿意接受什么类型的实体             |
| 407     | Rroxy Authentication            | 与401类似，要求对资源进行认证的代理服务器                    |
| 408     | Request Timeout                 | 请求时间过长，服务器回送此状态码并关闭连接                   |
| 409     | Confict                         | 请求在资源上引发的一些冲突                                   |
| 410     | Gone                            | 与404类似，服务器曾经拥有过这个资源                          |
| 411     | Length Required                 | 服务器要求在请求报文中包含Content-Length首部使用             |
| 412     | Precondition Failed             | 客户端发起条件请求，且其中一个条件失败                       |
| 413     | Request Entity Too Large        | 客户端发送的实体主体部分比服务端能够处理的或希望处理的要大   |
| 414     | Request URI Too Long            | 客户端发送的URL部分比服务端能够处理的要长                    |
| 415     | Unsupported Media Type          | 服务器无法理解或无法支持客户端所发的实体内容类型             |
| 416     | Requested Range Not Satisfiable | 请求报文所请求的是知道资源的某个范围，范围无效或范围无法满足时 |
| 417     | Expectation Failed              | 请求的Except请求首部包含一个期望，但服务器无法满足           |

### 3.4.5 500~599 - 服务器错误状态码

| 状态码  | 原因短语                   | 含义                                                         |
| ------- | -------------------------- | ------------------------------------------------------------ |
| **500** | Internal Server Error      | 服务器遇到一个妨碍它为请求提供服务的错误                     |
| 501     | Not Implemented            | 客户端发起的请求超出服务器的能力范围（例如请求方法不支持）   |
| **502** | Bad Gateway                | 作为代理或网关使用的服务器从请求响应链的下一条链路上收到一条伪响应（例如它无法连接到其父网关） |
| **503** | Service Unavaiable         | 服务器现在无法为请求提供服务                                 |
| 504     | Gateway Timeout            | 来自网关或代理的服务器在等待另外一个服务器对其请求响应超时   |
| 505     | HTTP Version Not Supported | 服务器不支持收到请求的协议版本                               |

## 3.5 首部
在报文中首部是用来提供信息，有些首部是某种报文专用的，有些首部是通用的

首部分类：
* 通用首部 - 客户端和服务器都可以使用的 *e.g.* Date首部
* 请求首部 - 请求报文特有，提供更多请求信息 *e.g.* Accept首部
* 响应首部 - 响应报文特有，提供更多响应信息 *e.g.* Server首部
* 实体首部 - 描述主体的长度和内容，或者资源自身 *e.g.* Content-type首部
* 扩展首部 - 规范中没有定义的新首部，HTTP程序也要接受它们并对其进行转发

### 3.5.1 通用首部

**通用首部**提供了与报文相关的最基本的信息

| 通用的信息性首部  | 描述                                                         |
| ----------------- | ------------------------------------------------------------ |
| Connection        | 允许客户端和服务器指定域请求/响应连接有关的选项              |
| Date              | 提供日期和事件的标志                                         |
| MIME-Version      | 发送端使用的MIME版本                                         |
| Trailer           | 如果报文采用了分块传输编码方式，就可以用这个首部列出位于报文拖挂部分的首部集合 |
| Transfer-Encoding | 告知接收端为了保证报文的可靠传输                             |
| Update            | 给出了发送端可能想要升级使用的新版本或协议                   |
| Via               | 显示报文经过的中间节点（代理、网关）                         |

| 通用缓存首部  | 描述                                         |
| ------------- | -------------------------------------------- |
| Cache-Control | 用于随报文传送缓存指示                       |
| Pragma        | 另一种随报文传送指示的方式，但并不专用于缓存 |

### 3.5.2 请求首部

**请求首部**用于说明是什么在发送请求，请求源自何处，或者客户端的喜好及能力

| 请求的信息性首部 | 描述                                         |
| ---------------- | -------------------------------------------- |
| Client-IP        | 提供了运行客户端的机器的IP地址               |
| From             | 提供了客户端用户的E-mail地址                 |
| Host             | 给出了接收请求的服务器的主机名和端口号       |
| Referer          | 提供了包含当前请求URI的文档和URL             |
| UA-Color         | 提供了与客户端显示器的显示颜色有关的信息     |
| UA-CPU           | 提供了与客户端CPU的类型或制造商              |
| UA-Disp          | 提供了与客户端显示器能力有关的信息           |
| UA-OS            | 给出了运行在客户端机器上的操作系统名称与版本 |
| UA-Pixels        | 提供了客户端显示器的像素信息                 |
| User-Agent       | 将发起请求的应用程序名称告知服务器           |

**Accept首部**为客户端提供了一只将其喜好的能力告知服务器的方式

| Accept首部      | 描述                               |
| --------------- | ---------------------------------- |
| Accept          | 告知服务器能够发送哪些媒体类型     |
| Accept-Charset  | 告知服务器能够发送哪些字符集       |
| Accept-Encoding | 告知服务器能够发送哪些编码方式     |
| Accept-Language | 告知服务器能够发送哪些语言         |
| TE              | 告知服务器可以使用那些扩展传输编码 |

**条件请求首部** - 客户端可以为请求添加限制，要求服务器在对请求进行响应之前，确保某个条件为真

| 条件请求首部        | 描述                                                         |
| ------------------- | ------------------------------------------------------------ |
| Expect              | 允许客户端列出某请求所要求的的服务器行为                     |
| If-Match            | 若实体标记与文档当前的实体标记匹配就获取文档                 |
| If-Modified-Since   | 除非在某个指定的日期之后资源被修改过，否则就限制这个请求     |
| If-None-Match       | 如果提供的实体标记与当前文档的实体标记不相符获取文档         |
| If-Range            | 允许对文档某个范围进行条件请求                               |
| If-Unmodified-Since | 除非在某个指定的日期之后资源没有被修改过，否则就限制这个请求 |
| Range               | 若服务器支持范围请求，则请求资源指定范围                     |

**安全请求首部**对请求进行质询/响应认证

| 安全请求首部  | 描述                                                 |
| ------------- | ---------------------------------------------------- |
| Authoruzation | 包含了客户端提供给服务器，以便对其自身进行认证的数据 |
| Cookie        | 客户端用它向服务器传送一个令牌                       |
| Cookie2       | 用来说明请求端支持的cookie版本                       |

| 代理请求首部        | 描述                                                         |
| ------------------- | ------------------------------------------------------------ |
| Max-Forward         | 在通往源端服务器的路径上，将请求转发给其他代理或网关的最大次数 |
| Proxy-Authorization | 与Authoruzation首部相同，但这个首部是在与代理进行认证时使用  |
| Proxy-Connection    | 与Connection首部相同，但这个首部是在与代理建立连接时使用     |

### 3.5.3 响应首部

**响应首部**为客户端提供了一些额外信息，比如谁在发送响应，响应者的功能，甚至与响应相关的一些特殊指令

| 响应的信息性首部 | 描述                                |
| ---------------- | ----------------------------------- |
| Age              | 响应持续时间                        |
| Public           | 服务器为其资源支持的请求方法列表    |
| Retry-After      | 若资源不可用的话，在此日期/时间重试 |
| Server           | 服务器应用程序软件的名称和版本      |
| Title            | HTML文档的源端给出的标题            |
| Warning          | 比原因短语中更详细一些的警告报文    |

**协商首部**为服务器和客户端提供对资源进行协商的能力

*e.g.* 服务器上某文档的法语跟德语译稿，可通过协商首部去挑选最适合的资源版本发送

| 协商首部     | 描述                                             |
| ------------ | ------------------------------------------------ |
| Accept-Range | 对此资源来说，服务器可接受的范围类型             |
| Vary         | 服务器查看的其他首部的列表，可能会使响应发送变化 |

**安全响应首部**是HTTP的质询/响应认证机制的响应侧

| 安全响应首部       | 描述                                                         |
| ------------------ | ------------------------------------------------------------ |
| Proxy-Authenticate | 来自代理的对客户端的质询列表                                 |
| Set-Cookie         | 不是真正的安全首部，但隐含安全功能，可以在客户端设置一个令牌以便服务器对客户端进行标识 |
| Set-Cookie2        | 与Set-Cookie类似                                             |
| WWW-Authenticate   | 来自服务器的对客户端的质询列表                               |

### 3.5.4 实体首部

**实体首部**提供了有关实体以及其内容的大量信息，从有关对象类型的信息，到能够对资源使用的各种有效请求方法

| 实体的信息性首部 | 描述                                                         |
| ---------------- | ------------------------------------------------------------ |
| Allow            | 列出了可以对实体执行的请求方法                               |
| Location         | 告知客户端实体实际上位于何处，用于将接收端定向到资源的URL上去 |

**内容首部**提供了与实体内容有关的特定信息，说明了其类型、尺寸以及处理它所需的其他有用信息

| 内部首部         | 描述                               |
| ---------------- | ---------------------------------- |
| Content-Base     | 解析主体中的相对URL时使用的基础URL |
| Content-Encoding | 对主体执行的任意编码方式           |
| Content-Language | 理解主体时最适宜使用的自然语言     |
| Content-Length   | 主体的长度或尺寸                   |
| Content-Location | 资源实际所处的位置                 |
| Content-MD5      | 主体的MD5校验和                    |
| Content-Range    | 在整个资源中此实体表示的字节范围   |
| Content-Type     | 这个主体的对象类型                 |

**实体缓存首部**提供了与被缓存实体相关的信息，以及更好地估计已缓存资源何时失效所需的线索

*e.g.* 验证已缓存的资源副本是否仍然有效所需的信息

| 实体缓存首部  | 描述                                                   |
| ------------- | ------------------------------------------------------ |
| ETag          | 与此实体相关的实体标记                                 |
| Expires       | 实体不再有效，要从原始的源端再次获取此实体的日期和时间 |
| Last-Modified | 实体最后一次被修改的日期和时间                         |

## 3.6 更多信息 - 略